<form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" class="needs-validation">
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="primerNombre" class="form-label">Primer Nombre *</label>
      <input 
        type="text" 
        class="form-control" 
        id="primerNombre" 
        formControlName="primerNombre" 
        [ngClass]="{'is-invalid': submitted && f['primerNombre'].errors}"
      >
      <div *ngIf="submitted && f['primerNombre'].errors" class="invalid-feedback">
        <div *ngIf="f['primerNombre'].errors['required']">El primer nombre es obligatorio</div>
        <div *ngIf="f['primerNombre'].errors['minlength']">El primer nombre debe tener al menos 2 caracteres</div>
        <div *ngIf="f['primerNombre'].errors['maxlength']">El primer nombre no puede tener más de 50 caracteres</div>
      </div>
    </div>
    
    <div class="col-md-6">
      <label for="segundoNombre" class="form-label">Segundo Nombre</label>
      <input 
        type="text" 
        class="form-control" 
        id="segundoNombre" 
        formControlName="segundoNombre"
        [ngClass]="{'is-invalid': submitted && f['segundoNombre'].errors}"
      >
      <div *ngIf="submitted && f['segundoNombre'].errors" class="invalid-feedback">
        <div *ngIf="f['segundoNombre'].errors['maxlength']">El segundo nombre no puede tener más de 50 caracteres</div>
      </div>
    </div>
  </div>
  
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="primerApellido" class="form-label">Primer Apellido *</label>
      <input 
        type="text" 
        class="form-control" 
        id="primerApellido" 
        formControlName="primerApellido"
        [ngClass]="{'is-invalid': submitted && f['primerApellido'].errors}"
      >
      <div *ngIf="submitted && f['primerApellido'].errors" class="invalid-feedback">
        <div *ngIf="f['primerApellido'].errors['required']">El primer apellido es obligatorio</div>
        <div *ngIf="f['primerApellido'].errors['minlength']">El primer apellido debe tener al menos 2 caracteres</div>
        <div *ngIf="f['primerApellido'].errors['maxlength']">El primer apellido no puede tener más de 50 caracteres</div>
      </div>
    </div>
    
    <div class="col-md-6">
      <label for="segundoApellido" class="form-label">Segundo Apellido</label>
      <input 
        type="text" 
        class="form-control" 
        id="segundoApellido" 
        formControlName="segundoApellido"
        [ngClass]="{'is-invalid': submitted && f['segundoApellido'].errors}"
      >
      <div *ngIf="submitted && f['segundoApellido'].errors" class="invalid-feedback">
        <div *ngIf="f['segundoApellido'].errors['maxlength']">El segundo apellido no puede tener más de 50 caracteres</div>
      </div>
    </div>
  </div>
  
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="telefono" class="form-label">Teléfono *</label>
      <input 
        type="tel" 
        class="form-control" 
        id="telefono" 
        formControlName="telefono"
        placeholder="Ej: 555-123-4567"
        [ngClass]="{'is-invalid': submitted && f['telefono'].errors}"
      >
      <div *ngIf="submitted && f['telefono'].errors" class="invalid-feedback">
        <div *ngIf="f['telefono'].errors['required']">El teléfono es obligatorio</div>
        <div *ngIf="f['telefono'].errors['pattern']">Ingrese un número de teléfono válido</div>
      </div>
    </div>
    
    <div class="col-md-6">
      <label for="email" class="form-label">Email *</label>
      <input 
        type="email" 
        class="form-control" 
        id="email" 
        formControlName="email"
        placeholder="ejemplo@correo.com"
        [ngClass]="{'is-invalid': submitted && f['email'].errors}"
      >
      <div *ngIf="submitted && f['email'].errors" class="invalid-feedback">
        <div *ngIf="f['email'].errors['required']">El email es obligatorio</div>
        <div *ngIf="f['email'].errors['email']">Ingrese un email válido</div>
      </div>
    </div>
  </div>
  
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="programa" class="form-label">Programa *</label>
      <select 
        class="form-select" 
        id="programa" 
        formControlName="programa"
        [ngClass]="{'is-invalid': submitted && f['programa'].errors}"
      >
        <option value="">Seleccione un programa</option>
        <option value="Acondicionamiento">Acondicionamiento</option>
        <option value="Readaptación">Readaptación</option>
        <option value="Recomposición">Recomposición</option>
      </select>
      <div *ngIf="submitted && f['programa'].errors" class="invalid-feedback">
        <div *ngIf="f['programa'].errors['required']">El programa es obligatorio</div>
      </div>
    </div>
    
    <div class="col-md-6">
      <label for="dob" class="form-label">Fecha de Nacimiento *</label>
      <input 
        type="date" 
        class="form-control" 
        id="dob" 
        formControlName="dob"
        [ngClass]="{'is-invalid': submitted && f['dob'].errors}"
      >
      <div *ngIf="submitted && f['dob'].errors" class="invalid-feedback">
        <div *ngIf="f['dob'].errors['required']">La fecha de nacimiento es obligatoria</div>
      </div>
    </div>
  </div>
  
  <div class="row mb-3">
    <div class="col-md-4">
      <label for="deporte" class="form-label">Deporte</label>
      <select 
        class="form-select" 
        id="deporte" 
        formControlName="deporte"
      >
        <option value="">Seleccionar deporte</option>
        <option *ngFor="let deporte of deportes" [value]="deporte.id">{{ deporte.nombre }}</option>
      </select>
      <div *ngIf="isLoading" class="form-text text-muted">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Cargando deportes...
      </div>
      <div *ngIf="!isLoading && deportes.length === 0" class="form-text text-danger">
        No se pudieron cargar los deportes. Por favor, inténtelo de nuevo.
      </div>
    </div>
    
    <div class="col-md-4">
      <label for="posicion" class="form-label">Posición</label>
      <select
        class="form-select"
        id="posicion"
        formControlName="posicion"
      >
        <option value="">Seleccionar posición</option>
        <option *ngFor="let posicion of posiciones" [value]="posicion.id">{{ posicion.nombre }}</option>
      </select>
      <div *ngIf="isLoading && usuarioForm.get('deporte')?.value" class="form-text text-muted">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Cargando posiciones...
      </div>
      <div *ngIf="!isLoading && usuarioForm.get('deporte')?.value && posiciones.length === 0" class="form-text text-danger">
        No hay posiciones disponibles para este deporte.
      </div>
      <div *ngIf="!usuarioForm.get('deporte')?.value" class="form-text text-muted">
        Seleccione un deporte primero
      </div>
    </div>
    
    <div class="col-md-4">
      <label for="lesiones" class="form-label">Lesiones</label>
      <input 
        type="text" 
        class="form-control" 
        id="lesiones" 
        formControlName="lesiones"
        placeholder="Ej: Tobillo derecho, Ninguna, etc."
      >
    </div>
  </div>
  
  <!-- Sección de Documentos -->
  <div class="card mt-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">Documentos</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Contrato -->
        <div class="col-md-6">
          <label for="contrato" class="form-label">Contrato</label>
          <div class="input-group">
            <input type="file" class="form-control" id="contrato" accept=".pdf" 
                  (change)="onDocumentoSeleccionado($event, 'contrato')">
            <button class="btn btn-outline-secondary" type="button" 
                  [class.disabled]="!nombresArchivos.contrato" 
                  [attr.aria-disabled]="!nombresArchivos.contrato"
                  (click)="documentos.contrato = null; nombresArchivos.contrato = ''">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <small class="form-text text-muted" *ngIf="nombresArchivos.contrato">
            Archivo seleccionado: {{ nombresArchivos.contrato }}
          </small>
        </div>
        
        <!-- Consentimiento -->
        <div class="col-md-6">
          <label for="consentimiento" class="form-label">Consentimiento</label>
          <div class="input-group">
            <input type="file" class="form-control" id="consentimiento" accept=".pdf" 
                  (change)="onDocumentoSeleccionado($event, 'consentimiento')">
            <button class="btn btn-outline-secondary" type="button" 
                  [class.disabled]="!nombresArchivos.consentimiento" 
                  [attr.aria-disabled]="!nombresArchivos.consentimiento"
                  (click)="documentos.consentimiento = null; nombresArchivos.consentimiento = ''">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <small class="form-text text-muted" *ngIf="nombresArchivos.consentimiento">
            Archivo seleccionado: {{ nombresArchivos.consentimiento }}
          </small>
        </div>
        
        <!-- Motivación -->
        <div class="col-md-6">
          <label for="motivacion" class="form-label">Motivación respecto al ejercicio</label>
          <div class="input-group">
            <input type="file" class="form-control" id="motivacion" accept=".pdf" 
                  (change)="onDocumentoSeleccionado($event, 'motivacion')">
            <button class="btn btn-outline-secondary" type="button" 
                  [class.disabled]="!nombresArchivos.motivacion" 
                  [attr.aria-disabled]="!nombresArchivos.motivacion"
                  (click)="documentos.motivacion = null; nombresArchivos.motivacion = ''">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <small class="form-text text-muted" *ngIf="nombresArchivos.motivacion">
            Archivo seleccionado: {{ nombresArchivos.motivacion }}
          </small>
        </div>
        
        <!-- Evaluación -->
        <div class="col-md-6">
          <label for="evaluacion" class="form-label">Hoja de evaluación</label>
          <div class="input-group">
            <input type="file" class="form-control" id="evaluacion" accept=".pdf" 
                  (change)="onDocumentoSeleccionado($event, 'evaluacion')">
            <button class="btn btn-outline-secondary" type="button" 
                  [class.disabled]="!nombresArchivos.evaluacion" 
                  [attr.aria-disabled]="!nombresArchivos.evaluacion"
                  (click)="documentos.evaluacion = null; nombresArchivos.evaluacion = ''">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <small class="form-text text-muted" *ngIf="nombresArchivos.evaluacion">
            Archivo seleccionado: {{ nombresArchivos.evaluacion }}
          </small>
        </div>
        
        <!-- Otros documentos -->
        <div class="col-md-6">
          <label for="otros" class="form-label">Otros documentos</label>
          <div class="input-group">
            <input type="file" class="form-control" id="otros" accept=".pdf" 
                  (change)="onDocumentoSeleccionado($event, 'otros')">
            <button class="btn btn-outline-secondary" type="button" 
                  [class.disabled]="!nombresArchivos.otros" 
                  [attr.aria-disabled]="!nombresArchivos.otros"
                  (click)="documentos.otros = null; nombresArchivos.otros = ''">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <small class="form-text text-muted" *ngIf="nombresArchivos.otros">
            Archivo seleccionado: {{ nombresArchivos.otros }}
          </small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mensaje de error -->
  <div *ngIf="errorMessage && showError" class="alert alert-danger mt-3">
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.2rem;"></i>
      <div>
        <strong>{{ errorMessage }}</strong>
        <div *ngIf="errorMessage.includes('No se puede conectar al servidor')" class="mt-2">
          <p class="mb-1">Para resolver este problema:</p>
          <ol class="ps-3 mb-0">
            <li>Verifica que el servidor API esté en ejecución en <code>http://localhost:3000</code></li>
            <li>Comprueba que no haya errores en la consola del servidor</li>
            <li>Asegúrate de que no hay restricciones de firewall que bloqueen la conexión</li>
          </ol>
          <p class="mt-2 mb-0"><small>Mientras tanto, puedes continuar usando otras funciones que no requieran conexión al servidor.</small></p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Botones de acción -->
  <div class="d-flex justify-content-end mt-4">
    <button type="button" class="btn btn-secondary me-2" (click)="cerrarModal()">Cancelar</button>
    <button type="submit" class="btn btn-primary" [class.disabled]="isLoading" [attr.aria-disabled]="isLoading">
      <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
    </button>
  </div>
</form>
