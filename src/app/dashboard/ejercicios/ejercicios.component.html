<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Gestión de Ejercicios</h5>
          <button class="btn btn-light" (click)="abrirModalCrearEjercicio()">
            <i class="bi bi-plus-circle me-2"></i>Crear Ejercicio
          </button>
        </div>
        <div class="card-body">
          <!-- Filtros y búsqueda -->
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text bg-light">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="Buscar ejercicio..." [(ngModel)]="terminoBusqueda">
                <button class="btn btn-outline-secondary" type="button" (click)="buscarEjercicios()">Buscar</button>
              </div>
            </div>
            <div class="col-md-6 text-end">
              <div class="btn-group">
                <button type="button" class="btn btn-outline-primary">
                  <i class="bi bi-filter me-1"></i>Filtrar
                </button>
                <button type="button" class="btn btn-outline-success">
                  <i class="bi bi-file-earmark-excel me-1"></i>Exportar
                </button>
              </div>
            </div>
          </div>
          
          <!-- Acordeón de Fases -->
          <div class="accordion" id="acordeonFases">
            <!-- Iteración sobre cada fase -->
            <div class="accordion-item mb-3 border rounded shadow-sm" *ngFor="let fase of fases">
              <h2 class="accordion-header">
                <button class="accordion-button" 
                        [class.collapsed]="!fase.expandido"
                        type="button" 
                        (click)="toggleFase(fase)">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <span class="fw-bold">{{ fase.nombre }}</span>
                    <span class="badge bg-info ms-2">{{ fase.ejercicios.length }} ejercicios</span>
                  </div>
                </button>
              </h2>
              <div class="accordion-collapse collapse" [class.show]="fase.expandido">
                <div class="accordion-body">
                  <p class="text-muted mb-3">{{ fase.indicaciones }}</p>
                  
                  <!-- Tabla de ejercicios -->
                  <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th scope="col" class="text-center">#</th>
                          <th scope="col">Nombre del Ejercicio</th>
                          <th scope="col">Cámara</th>
                          <th scope="col">Indicaciones</th>
                          <th scope="col" class="text-center">Video</th>
                          <th scope="col" class="text-center">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <ng-container *ngFor="let ejercicio of fase.ejercicios; let i = index">
                          <!-- Fila del ejercicio -->
                          <tr>
                            <td class="text-center">{{ i + 1 }}</td>
                            <td>{{ ejercicio.nombre }}</td>
                            <td>{{ ejercicio.camara }}</td>
                            <td>{{ ejercicio.indicaciones }}</td>
                            <td class="text-center">
                              <button 
                                *ngIf="ejercicio.videoUrl && ejercicio.videoUrl.trim() !== ''" 
                                class="btn btn-sm btn-primary" 
                                (click)="toggleVideo(ejercicio)"
                                title="Ver video">
                                <i class="bi bi-play-circle-fill me-1"></i> Ver
                              </button>
                              <span *ngIf="!ejercicio.videoUrl || ejercicio.videoUrl.trim() === ''" class="text-muted">
                                <i class="bi bi-dash-circle"></i>
                              </span>
                            </td>
                            <td class="text-center">
                              <div class="btn-group btn-group-sm">
                                <button 
                                  class="btn btn-sm btn-outline-primary" 
                                  title="Editar ejercicio"
                                  (click)="editarEjercicio(ejercicio, fase)">
                                  <i class="bi bi-pencil-fill me-1"></i> Editar
                                </button>
                                <button 
                                  class="btn btn-sm btn-outline-danger" 
                                  title="Eliminar ejercicio"
                                  (click)="eliminarEjercicio(ejercicio, fase)">
                                  <i class="bi bi-trash-fill me-1"></i> Eliminar
                                </button>
                              </div>
                            </td>
                          </tr>
                          
                          <!-- Fila para mostrar el video (se muestra cuando se hace clic en el botón de video) -->
                          <tr *ngIf="ejercicio.mostrarVideo && ejercicio.videoUrl">
                            <td colspan="6" class="p-3 border-0">
                              <div class="video-container mx-auto bg-light p-4 rounded shadow-sm position-relative">
                                <button 
                                  class="btn-close-video btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                  (click)="cerrarVideo(ejercicio)"
                                  title="Cerrar video">
                                  <i class="bi bi-x-lg"></i>
                                </button>
                                <div class="ratio ratio-16x9">
                                  <iframe 
                                    [src]="ejercicio.videoUrl | safe" 
                                    title="Video de {{ ejercicio.nombre }}" 
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen></iframe>
                                </div>
                              </div>
                            </td>
                          </tr>
                        </ng-container>
                        
                        <!-- Mensaje cuando no hay ejercicios -->
                        <tr *ngIf="fase.ejercicios.length === 0">
                          <td colspan="6" class="text-center py-3">
                            <div class="alert alert-info mb-0">
                              <i class="bi bi-info-circle me-2"></i>No hay ejercicios en esta fase
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Botón para agregar ejercicio a esta fase -->
                  <div class="text-end mt-3">
                    <button class="btn btn-sm btn-outline-primary" (click)="abrirModalConFase(fase)">
                      <i class="bi bi-plus-circle me-1"></i>Agregar ejercicio a {{ fase.nombre }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Componente Modal de Crear Ejercicio -->
<app-crear-ejercicios 
  [fases]="fases" 
  [modoEdicion]="modoEdicion" 
  [ejercicioParaEditar]="ejercicioSeleccionadoParaEditar" 
  [faseSeleccionadaInicial]="faseSeleccionadaParaEditar"
  (ejercicioCreado)="onEjercicioCreado($event)"
  (ejercicioEditado)="onEjercicioEditado($event)">
</app-crear-ejercicios>
